---
title: "MCMC - Performance"
subtitle: "Lecture 25"
author: "Dr. Colin Rundel"
footer: "Sta 663 - Spring 2025"
format:
  revealjs:
    theme: slides.scss
    transition: fade
    slide-number: true
    self-contained: true
execute: 
  echo: true
---

```{python setup}
#| include: false

import numpy as np
import matplotlib as mpl
import matplotlib.pyplot as plt
import pandas as pd
import seaborn as sns
import scipy

import patsy

import pymc as pm
import arviz as az

plt.rcParams['figure.dpi'] = 200

np.set_printoptions(
  edgeitems=30, linewidth=200,
  precision = 5, suppress=True
  #formatter=dict(float=lambda x: "%.5g" % x)
)

fa_file = '<svg aria-hidden="true" role="img" viewBox="0 0 384 512" style="height:1em;width:0.75em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;"><path d="M320 464c8.8 0 16-7.2 16-16V160H256c-17.7 0-32-14.3-32-32V48H64c-8.8 0-16 7.2-16 16V448c0 8.8 7.2 16 16 16H320zM0 64C0 28.7 28.7 0 64 0H229.5c17 0 33.3 6.7 45.3 18.7l90.5 90.5c12 12 18.7 28.3 18.7 45.3V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64z"/></svg>'

pd.set_option("display.width", 150)
pd.set_option("display.max_columns", 10)
pd.set_option("display.precision", 6)
```

# Stan

## Stan in Python & R

At the moment both Python & R offer two variants of Stan:

* `pystan` & `RStan` - native language interface to the underlying Stan C++ libraries

  * Former does not play nicely with Jupyter (or quarto or positron) - see [here](https://pystan.readthedocs.io/en/latest/faq.html#how-can-i-use-pystan-with-jupyter-notebook-or-jupyterlab) for fix

* `CmdStanPy` & `CmdStanR` - are wrappers around the `CmdStan` command line interface
  
  * Interface is through files (e.g. `model.stan`)

Any of the above tools will require a modern C++ toolchain (requires C++17 support).


## Stan process

![](imgs/stan.png){fig-align="center" width=75%}

::: {.aside}
From Charles Margossian's [Fundamentals of Stan](https://github.com/charlesm93/stanTutorial/tree/main/StanCon2023)
:::

## Stan file basics

Stan code is divided up into specific blocks depending on usage - all of the following blocks are optional but the ordering has to match what is given below.  

::: {.xsmall}
```stan
functions {
  // user-defined functions
}
data {
  // declares the required data for the model
}
transformed data {
   // allows the definition of constants and transforms of the data
}
parameters {
   // declares the modelâ€™s parameters
}
transformed parameters {
   // allows variables to be defined in terms of data and parameters
}
model {
   // defines the log probability function
}
generated quantities {
   // allows derived quantities based on parameters, data, and random number generation
}
```
:::

## A basic example

::: {.xsmall}
::: {.code-file .sourceCode .cell-code}
&nbsp; &nbsp; {{< fa file >}} &nbsp; `Lec25/bernoulli.stan`
:::
```stan
{{< include Lec25/bernoulli.stan >}}
```

::: {.code-file .sourceCode .cell-code}
&nbsp; &nbsp; {{< fa file >}} &nbsp; `Lec25/bernoulli.json`
:::
```json
{{< include Lec25/bernoulli.json >}}
```
:::

## Build & fit the model

::: {.small}
```{python}
from cmdstanpy import CmdStanModel
model = CmdStanModel(stan_file='Lec25/bernoulli.stan')
fit = model.sample(data='Lec25/bernoulli.json')
```
:::

## Results

::: {.xsmall}

```{python}
type(fit)
```

```{python}
fit
```
:::

## Summary

::: {.small}
```{python}
fit.summary()
```
:::

## Trace plots

::: {.xsmall}
```{python}
ax = az.plot_trace(fit, compact=False)
plt.show()
```
:::

## Diagnostics

::: {.xsmall}
```{python}
print(fit.diagnose())
```
:::

